---
- name: Ensure home directory parent exists
  ansible.builtin.file:
    path: "{{ clawdbot_home | dirname }}"
    state: directory
    mode: '0755'

- name: Create openclaw group with static GID
  ansible.builtin.group:
    name: "{{ clawdbot_user }}"
    gid: "{{ clawdbot_gid }}"
    system: true
    state: present

- name: Create openclaw system user with static UID/GID
  ansible.builtin.user:
    name: "{{ clawdbot_user }}"
    comment: "OpenClaw Service User"
    uid: "{{ clawdbot_uid }}"
    group: "{{ clawdbot_user }}"
    system: true
    shell: /bin/bash
    create_home: true
    home: "{{ clawdbot_home }}"
    state: present

- name: Ensure home directory has correct ownership
  ansible.builtin.file:
    path: "{{ clawdbot_home }}"
    state: directory
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0755'

- name: Add openclaw user to sudoers with restricted NOPASSWD
  ansible.builtin.copy:
    dest: /etc/sudoers.d/openclaw
    mode: '0440'
    owner: root
    group: root
    content: |
      # Allow openclaw user limited sudo without password
      {{ clawdbot_user }} ALL=(ALL) NOPASSWD: /usr/bin/systemctl, /usr/bin/docker, /usr/bin/journalctl, /usr/bin/loginctl
    validate: /usr/sbin/visudo -cf %s

# Fix DBus issues for systemd user services
- name: Get openclaw user ID
  ansible.builtin.command: id -u {{ clawdbot_user }}
  register: clawdbot_uid_result
  changed_when: false
  when: ansible_facts['os_family'] == 'Debian'

- name: Display openclaw user ID
  ansible.builtin.debug:
    msg: "OpenClaw user ID: {{ clawdbot_uid_result.stdout }}"
  when: ansible_facts['os_family'] == 'Debian'

- name: Enable lingering for openclaw user (allows systemd user services without login)
  ansible.builtin.command: loginctl enable-linger {{ clawdbot_user }}
  changed_when: false
  when: ansible_facts['os_family'] == 'Debian'

- name: Create runtime directory for openclaw user
  ansible.builtin.file:
    path: "/run/user/{{ clawdbot_uid_result.stdout }}"
    state: directory
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0700'
  when: ansible_facts['os_family'] == 'Debian'

- name: Store openclaw UID as fact for later use
  ansible.builtin.set_fact:
    clawdbot_uid_value: "{{ clawdbot_uid_result.stdout }}"
  when: ansible_facts['os_family'] == 'Debian'

# SSH key configuration
- name: Create .ssh directory for openclaw user
  ansible.builtin.file:
    path: "{{ clawdbot_home }}/.ssh"
    state: directory
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0700'

- name: Add SSH authorized keys for openclaw user
  ansible.builtin.authorized_key:
    user: "{{ clawdbot_user }}"
    state: present
    key: "{{ item }}"
  loop: "{{ clawdbot_ssh_keys }}"
  when: clawdbot_ssh_keys | length > 0

- name: Display SSH key configuration status
  ansible.builtin.debug:
    msg: "{{ clawdbot_ssh_keys | length }} SSH key(s) configured for openclaw user"
  when: clawdbot_ssh_keys | length > 0

- name: Display SSH key warning if none configured
  ansible.builtin.debug:
    msg: "No SSH keys configured. Set 'clawdbot_ssh_keys' variable to allow SSH access."
  when: clawdbot_ssh_keys | length == 0

# Darwin user setup
- name: Create darwin user
  ansible.builtin.user:
    name: darwin
    comment: "Darwin User"
    shell: /bin/bash
    create_home: true
    home: /home/darwin
    state: present

- name: Create .ssh directory for darwin user
  ansible.builtin.file:
    path: /home/darwin/.ssh
    state: directory
    owner: darwin
    group: darwin
    mode: '0700'

- name: Add SSH authorized keys for darwin user
  ansible.builtin.authorized_key:
    user: darwin
    state: present
    key: "{{ item }}"
  loop: "{{ clawdbot_ssh_keys }}"
  when: clawdbot_ssh_keys | length > 0

- name: Create .bash_profile for darwin user
  ansible.builtin.copy:
    dest: /home/darwin/.bash_profile
    owner: darwin
    group: darwin
    mode: '0644'
    content: |
      # Source .bashrc for interactive login shells (SSH)
      if [ -f "$HOME/.bashrc" ]; then
        . "$HOME/.bashrc"
      fi

# SSH daemon hardening
- name: Disable password authentication in sshd
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PasswordAuthentication'
    line: 'PasswordAuthentication no'
    state: present
    validate: '/usr/sbin/sshd -t -f %s'
  notify: restart sshd
  when: ansible_facts['os_family'] != 'Darwin'

- name: Disable challenge-response authentication in sshd
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?ChallengeResponseAuthentication|^#?KbdInteractiveAuthentication'
    line: 'KbdInteractiveAuthentication no'
    state: present
    validate: '/usr/sbin/sshd -t -f %s'
  notify: restart sshd
  when: ansible_facts['os_family'] != 'Darwin'

- name: Ensure PubkeyAuthentication is enabled in sshd
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PubkeyAuthentication'
    line: 'PubkeyAuthentication yes'
    state: present
    validate: '/usr/sbin/sshd -t -f %s'
  notify: restart sshd
  when: ansible_facts['os_family'] != 'Darwin'

- name: Disable root password login (permit key only)
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PermitRootLogin'
    line: 'PermitRootLogin prohibit-password'
    state: present
    validate: '/usr/sbin/sshd -t -f %s'
  notify: restart sshd
  when: ansible_facts['os_family'] != 'Darwin'

- name: Add bash guard at beginning of .bashrc
  ansible.builtin.blockinfile:
    path: "{{ clawdbot_home }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED - Bash guard"
    block: |
      # If not running in bash, skip the rest of this file
      [ -z "$BASH_VERSION" ] && return
    insertbefore: BOF
    create: true
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0644'

- name: Set XDG_RUNTIME_DIR in .bashrc for openclaw user
  ansible.builtin.lineinfile:
    path: "{{ clawdbot_home }}/.bashrc"
    line: 'export XDG_RUNTIME_DIR=/run/user/$(id -u)'
    state: present
    create: true
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0644'
  when: ansible_facts['os_family'] == 'Debian'

- name: Set DBUS_SESSION_BUS_ADDRESS in .bashrc for openclaw user
  ansible.builtin.blockinfile:
    path: "{{ clawdbot_home }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - DBus config"
    block: |
      # DBus session bus configuration
      if [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
        if [ -f "${XDG_RUNTIME_DIR}/bus" ]; then
          export DBUS_SESSION_BUS_ADDRESS="unix:path=${XDG_RUNTIME_DIR}/bus"
        fi
      fi
    create: true
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0644'
  when: ansible_facts['os_family'] == 'Debian'

- name: Create .bash_profile to source .bashrc on SSH login
  ansible.builtin.copy:
    dest: "{{ clawdbot_home }}/.bash_profile"
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0644'
    content: |
      # Source .bashrc for interactive login shells (SSH)
      if [ -f "$HOME/.bashrc" ]; then
        . "$HOME/.bashrc"
      fi
