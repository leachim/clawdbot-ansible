---
# =============================================================================
# OpenClaw data is stored on mounted volume and symlinked to ~/.openclaw
# This allows the user home to be at /home/openclaw while data persists on volume
# =============================================================================

# Cleanup: Remove root-level pnpm from previous installations
- name: Remove root-level pnpm (cleanup from previous installs)
  ansible.builtin.shell:
    cmd: npm uninstall -g pnpm || true
    executable: /bin/bash
  changed_when: false

- name: Remove stale root-level openclaw binary
  ansible.builtin.file:
    path: /usr/bin/openclaw
    state: absent

# Check if data already exists on the volume (from previous installation)
- name: Check if OpenClaw data exists on volume
  ansible.builtin.stat:
    path: "{{ clawdbot_data_dir }}"
  register: volume_data_check

# Fix ownership of existing data directory (handles UID/GID changes between runs)
- name: Fix ownership of existing data directory
  ansible.builtin.file:
    path: "{{ clawdbot_data_dir }}"
    state: directory
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    recurse: true
  when: volume_data_check.stat.exists

# Create data directory structure on volume (only if it doesn't exist)
- name: Create OpenClaw data directories on volume
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: "{{ item.mode }}"
  loop:
    - { path: "{{ clawdbot_data_dir }}", mode: '0700' }
    - { path: "{{ clawdbot_data_dir }}/sessions", mode: '0750' }
    - { path: "{{ clawdbot_data_dir }}/credentials", mode: '0700' }
    - { path: "{{ clawdbot_data_dir }}/data", mode: '0750' }
    - { path: "{{ clawdbot_data_dir }}/logs", mode: '0750' }
    - { path: "{{ clawdbot_data_dir }}/workspace", mode: '0750' }
  when: not volume_data_check.stat.exists

# Check current state of ~/.openclaw
- name: Check if ~/.openclaw exists
  ansible.builtin.stat:
    path: "{{ clawdbot_config_dir }}"
  register: home_openclaw_check

# Remove ~/.openclaw if it's a directory (not a symlink) - data should be on volume
- name: Remove ~/.openclaw directory if not a symlink
  ansible.builtin.file:
    path: "{{ clawdbot_config_dir }}"
    state: absent
  when:
    - home_openclaw_check.stat.exists
    - not home_openclaw_check.stat.islnk

# Create symlink from ~/.openclaw to volume
- name: Create symlink from ~/.openclaw to volume data
  ansible.builtin.file:
    src: "{{ clawdbot_data_dir }}"
    dest: "{{ clawdbot_config_dir }}"
    state: link
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
  when: not (home_openclaw_check.stat.exists and home_openclaw_check.stat.islnk)

- name: Create pnpm directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0755'
  loop:
    - "{{ clawdbot_home }}/.local/share/pnpm"
    - "{{ clawdbot_home }}/.local/share/pnpm/store"
    - "{{ clawdbot_home }}/.local/bin"

- name: Check if pnpm is already installed for openclaw user
  ansible.builtin.stat:
    path: "{{ clawdbot_home }}/.local/share/pnpm/pnpm"
  register: pnpm_binary_check

- name: Install pnpm via standalone installer as openclaw user
  ansible.builtin.shell:
    cmd: curl -fsSL https://get.pnpm.io/install.sh | bash -
    executable: /bin/bash
  become: true
  become_user: "{{ clawdbot_user }}"
  become_method: su
  environment:
    HOME: "{{ clawdbot_home }}"
    PNPM_HOME: "{{ clawdbot_home }}/.local/share/pnpm"
  when: not pnpm_binary_check.stat.exists

- name: Configure pnpm for openclaw user
  ansible.builtin.shell:
    cmd: |
      {{ clawdbot_home }}/.local/share/pnpm/pnpm config set global-dir {{ clawdbot_home }}/.local/share/pnpm
      {{ clawdbot_home }}/.local/share/pnpm/pnpm config set global-bin-dir {{ clawdbot_home }}/.local/share/pnpm
    executable: /bin/bash
  become: true
  become_user: "{{ clawdbot_user }}"
  become_method: su
  environment:
    HOME: "{{ clawdbot_home }}"
    XDG_CONFIG_HOME: "{{ clawdbot_home }}/.config"
  changed_when: true

- name: Fix ownership of .config directory
  ansible.builtin.file:
    path: "{{ clawdbot_home }}/.config"
    state: directory
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    recurse: true

- name: Display installation mode
  ansible.builtin.debug:
    msg: "ðŸ“¦ Installation mode: {{ clawdbot_install_mode }}"

# Include appropriate installation method based on mode
- name: Include release installation (pnpm install -g)
  ansible.builtin.include_tasks: clawdbot-release.yml
  when: clawdbot_install_mode == "release"

- name: Include development installation (git clone + build + link)
  ansible.builtin.include_tasks: clawdbot-development.yml
  when: clawdbot_install_mode == "development"

- name: Fix pnpm directory ownership (after all pnpm operations)
  ansible.builtin.file:
    path: "{{ clawdbot_home }}/.local/share/pnpm"
    state: directory
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    recurse: true

- name: Configure .bashrc for openclaw user (base config)
  ansible.builtin.blockinfile:
    path: "{{ clawdbot_home }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - OpenClaw pnpm"
    block: |
      # pnpm configuration
      export PNPM_HOME="{{ clawdbot_home }}/.local/share/pnpm"
      export PATH="{{ clawdbot_home }}/.local/bin:$PNPM_HOME:$PATH"

      # openclaw update wrapper (pnpm global installs aren't auto-detected)
      alias openclaw-update='pnpm add -g openclaw@latest && openclaw gateway restart'
    create: true
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0644'
    insertafter: EOF

# NOTE: We do NOT create config.yml here - openclaw onboard/configure will do that
# We also do NOT install the systemd service - openclaw onboard --install-daemon will do that
# The .openclaw directory structure is created above, but config and daemon are user-initiated

- name: Enforce secure permissions on OpenClaw data directory
  ansible.builtin.file:
    path: "{{ clawdbot_data_dir }}"
    state: directory
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0700'

# Configure gateway authentication to prevent unauthorized access
- name: Check if OpenClaw config exists
  ansible.builtin.stat:
    path: "{{ clawdbot_data_dir }}/config.json"
  register: openclaw_config_check

- name: Generate gateway auth token
  ansible.builtin.set_fact:
    gateway_auth_token: "{{ lookup('password', '/dev/null length=32 chars=ascii_letters,digits') }}"
  when: not openclaw_config_check.stat.exists

- name: Create OpenClaw config with gateway auth
  ansible.builtin.copy:
    dest: "{{ clawdbot_data_dir }}/config.json"
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0600'
    content: |
      {
        "gateway": {
          "auth": "{{ gateway_auth_token }}"
        }
      }
  when: not openclaw_config_check.stat.exists

- name: Update existing config with gateway auth if missing
  ansible.builtin.shell:
    cmd: |
      CONFIG="{{ clawdbot_data_dir }}/config.json"
      if ! grep -q '"auth"' "$CONFIG" 2>/dev/null; then
        TOKEN=$(openssl rand -hex 16)
        if command -v jq &>/dev/null; then
          jq --arg token "$TOKEN" '.gateway.auth = $token' "$CONFIG" > "$CONFIG.tmp" && mv "$CONFIG.tmp" "$CONFIG"
        else
          export CONFIG TOKEN
          python3 -c 'import json,os; c=json.load(open(os.environ["CONFIG"])); c.setdefault("gateway",{})["auth"]=os.environ["TOKEN"]; json.dump(c,open(os.environ["CONFIG"],"w"),indent=2)'
        fi
        echo "CHANGED: Added gateway.auth token"
      else
        echo "OK: gateway.auth already configured"
      fi
    executable: /bin/bash
  become: true
  become_user: "{{ clawdbot_user }}"
  become_method: su
  register: gateway_auth_result
  changed_when: "'CHANGED' in gateway_auth_result.stdout"
  when: openclaw_config_check.stat.exists

- name: Display gateway auth token notice
  ansible.builtin.debug:
    msg: >
      Gateway auth token has been configured.
      Retrieve it from {{ clawdbot_data_dir }}/config.json on the target host.

- name: Remove stale system-level service (migrated to user service)
  ansible.builtin.file:
    path: /etc/systemd/system/openclaw-gateway.service
    state: absent
  register: system_service_removed

- name: Reload system daemon after removing stale service
  ansible.builtin.systemd:
    daemon_reload: true
  when: system_service_removed.changed

- name: Enable lingering for openclaw user (user services persist without login)
  ansible.builtin.command: loginctl enable-linger {{ clawdbot_user }}
  changed_when: false

- name: Create user systemd directory
  ansible.builtin.file:
    path: "{{ clawdbot_home }}/.config/systemd/user"
    state: directory
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0755'

- name: Deploy openclaw-gateway user systemd service
  ansible.builtin.template:
    src: clawdbot-host.service.j2
    dest: "{{ clawdbot_home }}/.config/systemd/user/openclaw-gateway.service"
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0644'
  register: service_file_deployed

- name: Reload user systemd daemon
  ansible.builtin.command:
    cmd: systemd-run --machine={{ clawdbot_user }}@ --user --wait --pipe systemctl --user daemon-reload
  when: service_file_deployed.changed

- name: Enable and start openclaw-gateway user service
  ansible.builtin.command:
    cmd: systemd-run --machine={{ clawdbot_user }}@ --user --wait --pipe systemctl --user enable --now openclaw-gateway
  changed_when: true
