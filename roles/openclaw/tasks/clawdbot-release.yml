---
# Release mode installation - Install via pnpm from npm registry

- name: Install OpenClaw globally as openclaw user (using pnpm)
  ansible.builtin.shell:
    cmd: "{{ clawdbot_home }}/.local/share/pnpm/pnpm install -g openclaw@latest"
    executable: /bin/bash
  become: true
  become_user: "{{ clawdbot_user }}"
  become_method: su
  environment:
    PNPM_HOME: "{{ clawdbot_home }}/.local/share/pnpm"
    PATH: "{{ clawdbot_home }}/.local/share/pnpm:{{ clawdbot_home }}/.local/bin:/home/linuxbrew/.linuxbrew/bin:/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin"
    HOME: "{{ clawdbot_home }}"
  register: openclaw_install
  changed_when: "'Already up to date' not in openclaw_install.stdout"

- name: Verify OpenClaw installation
  ansible.builtin.shell:
    cmd: "{{ clawdbot_home }}/.local/share/pnpm/openclaw --version"
    executable: /bin/bash
  become: true
  become_user: "{{ clawdbot_user }}"
  become_method: su
  environment:
    HOME: "{{ clawdbot_home }}"
  register: openclaw_version
  changed_when: false

- name: Display installed OpenClaw version (release)
  ansible.builtin.debug:
    msg: "OpenClaw installed from npm: {{ openclaw_version.stdout }}"

- name: Remove old openclaw update cron job
  ansible.builtin.cron:
    name: "openclaw update"
    user: "{{ clawdbot_user }}"
    state: absent

- name: Set up cron job for OpenClaw updates (every 6 hours)
  ansible.builtin.cron:
    name: "openclaw pnpm update"
    user: "{{ clawdbot_user }}"
    minute: "0"
    hour: "*/6"
    job: >-
      HOME={{ clawdbot_home }}
      PNPM_HOME={{ clawdbot_home }}/.local/share/pnpm
      {{ clawdbot_home }}/.local/share/pnpm/pnpm add -g openclaw@latest >> {{ clawdbot_home }}/logs/openclaw-update.log 2>&1
      && {{ clawdbot_home }}/.local/share/pnpm/openclaw gateway restart >> {{ clawdbot_home }}/logs/openclaw-update.log 2>&1
    state: present

- name: Install OpenClaw shell completions for bash
  ansible.builtin.shell: |
    su - {{ clawdbot_user }} -c '{{ clawdbot_home }}/.local/share/pnpm/openclaw completions bash > {{ clawdbot_home }}/.openclaw-completions.bash 2>/dev/null || true'
  args:
    creates: "{{ clawdbot_home }}/.openclaw-completions.bash"

- name: Add bash completion to .bashrc
  ansible.builtin.lineinfile:
    path: "{{ clawdbot_home }}/.bashrc"
    line: '[ -f ~/.openclaw-completions.bash ] && source ~/.openclaw-completions.bash'
    state: present
    create: true
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0644'

